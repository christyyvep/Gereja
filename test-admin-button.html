<!DOCTYPE html>
<html>
<head>
    <title>Admin Button Test - MyRajawali</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto;
        }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px;
            background: #f9f9f9;
        }
        .btn { 
            background: #dc2626; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 8px 4px;
            font-size: 14px;
        }
        .btn:hover { background: #b91c1c; }
        .btn.secondary { background: #6b7280; }
        .btn.secondary:hover { background: #4b5563; }
        .success { color: #059669; background: #ecfdf5; padding: 12px; border-radius: 6px; }
        .error { color: #dc2626; background: #fef2f2; padding: 12px; border-radius: 6px; }
        .info { color: #0369a1; background: #eff6ff; padding: 12px; border-radius: 6px; }
        .code { 
            background: #1f2937; 
            color: #f9fafb; 
            padding: 16px; 
            border-radius: 8px; 
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        h1 { color: #1f2937; border-bottom: 2px solid #dc2626; padding-bottom: 10px; }
        h2 { color: #374151; margin-top: 0; }
    </style>
</head>
<body>
    <h1>üîç Admin Button Test Tool</h1>
    <p>Tool untuk test dan debug masalah admin button di MyRajawali app.</p>
    
    <div class="section">
        <h2>1. Quick Actions</h2>
        <button class="btn" onclick="checkStatus()">Check Current Status</button>
        <button class="btn" onclick="setAdminRole()">Set Admin Role</button>
        <button class="btn secondary" onclick="openApp()">Open MyRajawali App</button>
        <button class="btn secondary" onclick="clearData()">Clear All Data</button>
    </div>
    
    <div class="section">
        <h2>2. Current Status</h2>
        <div id="status-result">Click "Check Current Status" to see information...</div>
    </div>
    
    <div class="section">
        <h2>3. Console Commands</h2>
        <p>Buka Developer Tools (F12) dan jalankan command berikut di Console:</p>
        <div class="code">
// Check user data
checkStatus()

// Set user as admin
setAdminRole()

// Force refresh user data (if app is open)
if (window.opener) {
    window.opener.debugUser?.refreshUserData?.()
}

// Open app in new tab
openApp()
        </div>
    </div>

    <script>
        function checkStatus() {
            const result = document.getElementById('status-result');
            try {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                const myRajawaliUser = JSON.parse(localStorage.getItem('myrajawali_user') || 'null');
                
                let html = '<div class="info">';
                html += '<strong>üìã Current Status:</strong><br><br>';
                
                if (user) {
                    html += `üë§ User: ${user.nama || 'Unknown'}<br>`;
                    html += `üîê Role: ${user.role || 'jemaat'}<br>`;
                    html += `üìß Email: ${user.email || 'N/A'}<br>`;
                    html += `üÜî ID: ${user.id || 'N/A'}<br><br>`;
                    
                    const isAdmin = ['admin', 'administrator', 'gembala'].includes((user.role || '').toLowerCase());
                    if (isAdmin) {
                        html += '<div class="success">‚úÖ User HAS admin role - admin button should be visible!</div>';
                    } else {
                        html += '<div class="error">‚ùå User does NOT have admin role - admin button will not be visible</div>';
                    }
                } else {
                    html += '<div class="error">‚ùå No user logged in</div>';
                }
                
                html += '<br><br><strong>üîç Raw Data:</strong><br>';
                html += `localStorage.user: ${user ? JSON.stringify(user, null, 2) : 'null'}<br><br>`;
                html += `localStorage.myrajawali_user: ${myRajawaliUser ? JSON.stringify(myRajawaliUser, null, 2) : 'null'}`;
                html += '</div>';
                
                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function setAdminRole() {
            const result = document.getElementById('status-result');
            try {
                let user = JSON.parse(localStorage.getItem('user') || 'null');
                
                if (!user) {
                    // Create test admin user
                    user = {
                        id: 'test-admin-' + Date.now(),
                        nama: 'Test Admin',
                        email: 'admin@test.com',
                        role: 'admin',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                } else {
                    // Update existing user
                    user.role = 'admin';
                    user.updatedAt = new Date().toISOString();
                }
                
                // Save to both localStorage keys
                localStorage.setItem('user', JSON.stringify(user));
                localStorage.setItem('myrajawali_user', JSON.stringify(user));
                
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ Admin role set successfully!<br><br>
                        üë§ User: ${user.nama}<br>
                        üîê Role: ${user.role}<br><br>
                        <strong>Next steps:</strong><br>
                        1. Open MyRajawali app<br>
                        2. Admin button should now be visible<br>
                        3. If not visible, try refreshing the app
                    </div>
                `;
                
                // Try to refresh app if it's open
                if (window.opener && window.opener.location.origin === window.location.origin) {
                    try {
                        // Force refresh user data in the app
                        if (window.opener.debugUser && window.opener.debugUser.refreshUserData) {
                            window.opener.debugUser.refreshUserData();
                        }
                        
                        // Dispatch storage event to trigger reactivity
                        window.opener.dispatchEvent(new StorageEvent('storage', {
                            key: 'user',
                            newValue: JSON.stringify(user),
                            storageArea: localStorage
                        }));
                        
                        console.log('‚úÖ Triggered app refresh');
                    } catch (e) {
                        console.log('‚ÑπÔ∏è Could not trigger app refresh:', e.message);
                    }
                }
                
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function openApp() {
            const appUrl = 'http://localhost:8085/';
            window.open(appUrl, '_blank');
            
            const result = document.getElementById('status-result');
            result.innerHTML = `
                <div class="info">
                    üöÄ Opening MyRajawali app at: <a href="${appUrl}" target="_blank">${appUrl}</a><br><br>
                    After app opens:<br>
                    1. Login with any user<br>
                    2. Check if admin button appears in navbar<br>
                    3. If not, come back here and click "Set Admin Role"
                </div>
            `;
        }
        
        function clearData() {
            if (confirm('Are you sure you want to clear all localStorage data?')) {
                localStorage.clear();
                
                const result = document.getElementById('status-result');
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ All localStorage data cleared!<br><br>
                        You can now:<br>
                        1. Set new admin role<br>
                        2. Open app and login fresh<br>
                        3. Test admin button functionality
                    </div>
                `;
            }
        }
        
        // Auto-check status on page load
        window.addEventListener('load', () => {
            checkStatus();
            
            console.log('üõ†Ô∏è Admin Button Test Tool loaded');
            console.log('Available functions:');
            console.log('  checkStatus() - Check current user status');
            console.log('  setAdminRole() - Set current user as admin');
            console.log('  openApp() - Open MyRajawali app');
            console.log('  clearData() - Clear all localStorage');
        });
    </script>
</body>
</html>
