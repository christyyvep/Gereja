<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Telegram Broadcast System - MyRajawali</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .result {
            background: #e9ecef;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Test Telegram Broadcast System</h1>
        <p><strong>MyRajawali Bot:</strong> @MyRajawali_bot</p>
        
        <div class="test-section">
            <h2>1. Test Basic Bot Connection</h2>
            <button onclick="testBotConnection()">Test Bot Token</button>
            <div id="botResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. Add Test User Registration</h2>
            <input type="text" id="testFirstName" placeholder="First Name" value="Test User">
            <input type="text" id="testLastName" placeholder="Last Name" value="Bot">
            <input type="text" id="testUsername" placeholder="Username" value="testuser">
            <button onclick="addTestUser()">Add Test User</button>
            <div id="testUserResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. Check Registrations</h2>
            <button onclick="checkRegistrations()">Check All Registrations</button>
            <div id="registrationsResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. Test Approve User</h2>
            <p>First check registrations above, then use the Telegram User ID:</p>
            <input type="text" id="approveUserId" placeholder="Telegram User ID">
            <button onclick="approveTestUser()">Approve User</button>
            <div id="approveResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>5. Test Broadcast Renungan</h2>
            <input type="text" id="renunganTitle" placeholder="Judul Renungan" value="Test Renungan Harian">
            <input type="text" id="renunganVerse" placeholder="Ayat Alkitab" value="Yohanes 3:16">
            <textarea id="renunganContent" placeholder="Isi renungan...">Karena begitu besar kasih Allah akan dunia ini, sehingga Ia telah mengaruniakan Anak-Nya yang tunggal, supaya setiap orang yang percaya kepada-Nya tidak binasa, melainkan beroleh hidup yang kekal.</textarea>
            <textarea id="renunganReflection" placeholder="Refleksi...">Kasih Allah begitu besar sehingga Ia memberikan yang terbaik bagi kita. Mari kita hidup dalam kasih-Nya setiap hari.</textarea>
            <textarea id="renunganPrayer" placeholder="Doa...">Bapa yang di surga, terima kasih atas kasih-Mu yang besar. Tolong kami untuk selalu hidup dalam kasih-Mu. Dalam nama Yesus kami berdoa. Amin.</textarea>
            <button onclick="testBroadcastRenungan()">Broadcast Test Renungan</button>
            <div id="broadcastResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>6. Quick Actions</h2>
            <button onclick="setupWebhook()">Setup Webhook</button>
            <button onclick="getWebhookInfo()">Get Webhook Info</button>
            <button onclick="deleteWebhook()">Delete Webhook</button>
            <div id="webhookResult" class="result"></div>
        </div>

        <div id="globalStatus" class="status" style="display: none;"></div>
    </div>

    <script type="module">
        // Import services
        import simpleTelegramRegistration from '/src/services/simpleTelegramRegistration.js'
        import telegramService from '/src/services/telegramService.js'

        // Make functions global
        window.simpleTelegramRegistration = simpleTelegramRegistration
        window.telegramService = telegramService

        // Bot configuration
        const BOT_TOKEN = '8330380524:AAFCEuYTsuPk3Ev4E0flNScn0BhO7K76Myw'
        const WEBHOOK_URL = 'https://your-server.com/webhook/telegram' // Update ini nanti

        // Helper functions
        window.showStatus = (message, type = 'loading') => {
            const status = document.getElementById('globalStatus')
            status.textContent = message
            status.className = `status ${type}`
            status.style.display = 'block'
            
            if (type !== 'loading') {
                setTimeout(() => {
                    status.style.display = 'none'
                }, 5000)
            }
        }

        window.logResult = (elementId, message, isError = false) => {
            const element = document.getElementById(elementId)
            element.textContent = message
            element.className = `result ${isError ? 'error' : 'success'}`
        }

        // Test functions
        window.testBotConnection = async () => {
            try {
                showStatus('Testing bot connection...', 'loading')
                
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getMe`)
                const result = await response.json()
                
                if (result.ok) {
                    logResult('botResult', `‚úÖ Bot Connection Success!\n\nBot Info:\n${JSON.stringify(result.result, null, 2)}`)
                    showStatus('Bot connection test successful!', 'success')
                } else {
                    logResult('botResult', `‚ùå Bot Connection Failed:\n${JSON.stringify(result, null, 2)}`, true)
                    showStatus('Bot connection test failed!', 'error')
                }
            } catch (error) {
                logResult('botResult', `‚ùå Error: ${error.message}`, true)
                showStatus('Bot connection test error!', 'error')
            }
        }

        window.addTestUser = async () => {
            try {
                showStatus('Adding test user...', 'loading')
                
                const firstName = document.getElementById('testFirstName').value
                const lastName = document.getElementById('testLastName').value
                const username = document.getElementById('testUsername').value
                
                const result = await simpleTelegramRegistration.addTestUser({
                    first_name: firstName,
                    last_name: lastName,
                    username: username
                })
                
                if (result.success) {
                    logResult('testUserResult', `‚úÖ Test User Added!\n\nStatus: ${result.status}\nNow check registrations to see the pending user.`)
                    showStatus('Test user added successfully!', 'success')
                } else {
                    logResult('testUserResult', `‚ùå Failed to add test user:\n${result.error}`, true)
                    showStatus('Failed to add test user!', 'error')
                }
            } catch (error) {
                logResult('testUserResult', `‚ùå Error: ${error.message}`, true)
                showStatus('Add test user error!', 'error')
            }
        }

        window.checkRegistrations = async () => {
            try {
                showStatus('Checking registrations...', 'loading')
                
                const debug = await simpleTelegramRegistration.debugRegistrations()
                
                logResult('registrationsResult', `üìä Registration Status:\n\nTotal: ${debug.total}\nPending: ${debug.pending}\nApproved: ${debug.approved}\n\nAll Documents:\n${JSON.stringify(debug.allDocs, null, 2)}`)
                showStatus('Registration check completed!', 'success')
                
            } catch (error) {
                logResult('registrationsResult', `‚ùå Error: ${error.message}`, true)
                showStatus('Registration check error!', 'error')
            }
        }

        window.approveTestUser = async () => {
            try {
                showStatus('Approving user...', 'loading')
                
                const userId = document.getElementById('approveUserId').value
                if (!userId) {
                    alert('Please enter Telegram User ID')
                    return
                }
                
                const result = await simpleTelegramRegistration.approveRegistration(userId, 'test-admin')
                
                if (result.success) {
                    logResult('approveResult', `‚úÖ User Approved!\n\n${result.message}`)
                    showStatus('User approved successfully!', 'success')
                } else {
                    logResult('approveResult', `‚ùå Approval failed:\n${result.message}`, true)
                    showStatus('User approval failed!', 'error')
                }
            } catch (error) {
                logResult('approveResult', `‚ùå Error: ${error.message}`, true)
                showStatus('User approval error!', 'error')
            }
        }

        window.testBroadcastRenungan = async () => {
            try {
                showStatus('Broadcasting renungan...', 'loading')
                
                const renunganData = {
                    id: 'test-' + Date.now(),
                    title: document.getElementById('renunganTitle').value,
                    verse: document.getElementById('renunganVerse').value,
                    content: document.getElementById('renunganContent').value,
                    reflection: document.getElementById('renunganReflection').value,
                    prayer: document.getElementById('renunganPrayer').value,
                    date: new Date()
                }
                
                const result = await telegramService.sendRenunganToTelegram(renunganData)
                
                if (result.success) {
                    logResult('broadcastResult', `‚úÖ Broadcast Success!\n\nSent to: ${result.results.success}/${result.results.total} users\nFailed: ${result.results.failed}\n\nDetails:\n${JSON.stringify(result.results.details, null, 2)}`)
                    showStatus('Renungan broadcast successful!', 'success')
                } else {
                    logResult('broadcastResult', `‚ùå Broadcast failed:\n${JSON.stringify(result, null, 2)}`, true)
                    showStatus('Renungan broadcast failed!', 'error')
                }
            } catch (error) {
                logResult('broadcastResult', `‚ùå Error: ${error.message}`, true)
                showStatus('Renungan broadcast error!', 'error')
            }
        }

        window.setupWebhook = async () => {
            try {
                showStatus('Setting up webhook...', 'loading')
                
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/setWebhook`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: WEBHOOK_URL,
                        allowed_updates: ['message']
                    })
                })
                
                const result = await response.json()
                logResult('webhookResult', `Webhook Setup Result:\n${JSON.stringify(result, null, 2)}`)
                
                if (result.ok) {
                    showStatus('Webhook setup successful!', 'success')
                } else {
                    showStatus('Webhook setup failed!', 'error')
                }
            } catch (error) {
                logResult('webhookResult', `‚ùå Error: ${error.message}`, true)
                showStatus('Webhook setup error!', 'error')
            }
        }

        window.getWebhookInfo = async () => {
            try {
                showStatus('Getting webhook info...', 'loading')
                
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getWebhookInfo`)
                const result = await response.json()
                
                logResult('webhookResult', `Webhook Info:\n${JSON.stringify(result, null, 2)}`)
                showStatus('Webhook info retrieved!', 'success')
            } catch (error) {
                logResult('webhookResult', `‚ùå Error: ${error.message}`, true)
                showStatus('Webhook info error!', 'error')
            }
        }

        window.deleteWebhook = async () => {
            try {
                showStatus('Deleting webhook...', 'loading')
                
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/deleteWebhook`, {
                    method: 'POST'
                })
                const result = await response.json()
                
                logResult('webhookResult', `Webhook Delete Result:\n${JSON.stringify(result, null, 2)}`)
                showStatus('Webhook deleted!', 'success')
            } catch (error) {
                logResult('webhookResult', `‚ùå Error: ${error.message}`, true)
                showStatus('Webhook delete error!', 'error')
            }
        }

        // Auto-run bot connection test on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testBotConnection()
            }, 1000)
        })
    </script>
</body>
</html>
