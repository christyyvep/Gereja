<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Password Format</title>
</head>
<body>
    <h1>Debug Password Format - User Analysis</h1>
    
    <div>
        <h3>Check User Password Format</h3>
        <input type="text" id="username" placeholder="Enter username (e.g., irene, christy potabuga)" />
        <button onclick="checkUser()">Check User</button>
    </div>
    
    <div>
        <h3>Test Password Verification</h3>
        <input type="text" id="testuser" placeholder="Username" />
        <input type="password" id="testpass" placeholder="Password to test" />
        <button onclick="testPassword()">Test Password</button>
    </div>
    
    <div id="results" style="margin-top: 20px; padding: 10px; background: #f0f0f0;">
        <p>Results will appear here...</p>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js'
        import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js'

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA3Rm_kfJo5QsmJCMfNJYdoV9CYfN9o4gE",
            authDomain: "myrajawali-app.firebaseapp.com",
            projectId: "myrajawali-app",
            storageBucket: "myrajawali-app.appspot.com",
            messagingSenderId: "1090503445464",
            appId: "1:1090503445464:web:7e50c38b29b1af47ce66eb"
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig)
        const db = getFirestore(app)

        // Import crypto-js
        const script = document.createElement('script')
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js'
        document.head.appendChild(script)

        // Hash functions (copy from auth services)
        function hashPasswordSHA256(password) {
            return CryptoJS.SHA256(password).toString()
        }

        function hashPasswordPBKDF2(password) {
            const salt = CryptoJS.lib.WordArray.random(128/8)
            const hash = CryptoJS.PBKDF2(password, salt, {
                keySize: 256/32,
                iterations: 10000
            })
            return salt.toString() + ':' + hash.toString()
        }

        function verifyPasswordPBKDF2(password, storedHash) {
            try {
                // Handle plain text password (legacy)
                if (!storedHash.includes(':')) {
                    console.log('Legacy plain text password detected')
                    return password === storedHash
                }
                
                // Standard PBKDF2 hash verification
                const [salt, hash] = storedHash.split(':')
                const hashToVerify = CryptoJS.PBKDF2(password, CryptoJS.enc.Hex.parse(salt), {
                    keySize: 256/32,
                    iterations: 10000
                })
                return hash === hashToVerify.toString()
            } catch (error) {
                console.error('Error verifying password:', error)
                return false
            }
        }

        // Global functions
        window.checkUser = async function() {
            const username = document.getElementById('username').value.trim()
            const resultsDiv = document.getElementById('results')
            
            if (!username) {
                resultsDiv.innerHTML = '<p style="color: red;">Please enter a username</p>'
                return
            }

            try {
                resultsDiv.innerHTML = '<p>Checking user...</p>'
                
                // Find user in database
                const jemaatRef = collection(db, 'jemaat')
                
                // Try exact match first
                const exactQuery = query(jemaatRef, where('nama', '==', username))
                const exactSnapshot = await getDocs(exactQuery)
                
                let userDoc = null
                let userData = null
                
                if (!exactSnapshot.empty) {
                    userDoc = exactSnapshot.docs[0]
                    userData = userDoc.data()
                } else {
                    // Try case-insensitive search
                    const allSnapshot = await getDocs(jemaatRef)
                    allSnapshot.forEach((doc) => {
                        const data = doc.data()
                        if (data.nama && data.nama.toLowerCase().includes(username.toLowerCase())) {
                            userDoc = doc
                            userData = data
                        }
                    })
                }
                
                if (!userData) {
                    resultsDiv.innerHTML = '<p style="color: red;">User not found</p>'
                    return
                }
                
                // Analyze password format
                const password = userData.password
                let passwordType = 'Unknown'
                let passwordLength = password ? password.length : 0
                
                if (!password) {
                    passwordType = 'No password set'
                } else if (password.includes(':')) {
                    passwordType = 'PBKDF2 with salt (Secure)'
                } else if (password.length === 64) {
                    passwordType = 'SHA256 hash (Legacy)'
                } else {
                    passwordType = 'Plain text (Very old)'
                }
                
                resultsDiv.innerHTML = `
                    <h4>User Analysis: ${userData.nama}</h4>
                    <p><strong>ID:</strong> ${userDoc.id}</p>
                    <p><strong>Is Registered:</strong> ${userData.isRegistered ? 'Yes' : 'No'}</p>
                    <p><strong>Role:</strong> ${userData.role || 'No role set'}</p>
                    <p><strong>Password Type:</strong> ${passwordType}</p>
                    <p><strong>Password Length:</strong> ${passwordLength}</p>
                    <p><strong>Has Password:</strong> ${password ? 'Yes' : 'No'}</p>
                    <p><strong>Failed Login Attempts:</strong> ${userData.failedLoginAttempts || 0}</p>
                    <p><strong>Last Login:</strong> ${userData.lastLoginAt ? new Date(userData.lastLoginAt.seconds * 1000).toLocaleString() : 'Never'}</p>
                    <p><strong>Password Sample:</strong> ${password ? password.substring(0, 20) + '...' : 'N/A'}</p>
                `
            } catch (error) {
                console.error('Error checking user:', error)
                resultsDiv.innerHTML = `
                    <p style="color: red;">❌ Error checking user</p>
                    <p>Error: ${error.message}</p>
                `
            }
        }

        window.testPassword = async function() {
            const username = document.getElementById('testuser').value.trim()
            const password = document.getElementById('testpass').value
            const resultsDiv = document.getElementById('results')
            
            if (!username || !password) {
                resultsDiv.innerHTML = '<p style="color: red;">Please enter both username and password</p>'
                return
            }

            try {
                resultsDiv.innerHTML = '<p>Testing password...</p>'
                
                // Find user
                const jemaatRef = collection(db, 'jemaat')
                const exactQuery = query(jemaatRef, where('nama', '==', username))
                const exactSnapshot = await getDocs(exactQuery)
                
                if (exactSnapshot.empty) {
                    resultsDiv.innerHTML = '<p style="color: red;">User not found</p>'
                    return
                }
                
                const userData = exactSnapshot.docs[0].data()
                const storedPassword = userData.password
                
                if (!storedPassword) {
                    resultsDiv.innerHTML = '<p style="color: red;">No password set for this user</p>'
                    return
                }
                
                // Test different verification methods
                const sha256Hash = hashPasswordSHA256(password)
                const sha256Match = storedPassword === sha256Hash
                
                let pbkdf2Match = false
                try {
                    pbkdf2Match = verifyPasswordPBKDF2(password, storedPassword)
                } catch (e) {
                    console.error('PBKDF2 verification failed:', e)
                }
                
                const plainTextMatch = storedPassword === password
                
                resultsDiv.innerHTML = `
                    <h4>Password Test Results for: ${username}</h4>
                    <p><strong>Stored Password:</strong> ${storedPassword.substring(0, 30)}...</p>
                    <p><strong>Input Password:</strong> ${password}</p>
                    <hr>
                    <p><strong>SHA256 Match:</strong> ${sha256Match ? '✅ YES' : '❌ NO'}</p>
                    <p><strong>PBKDF2 Match:</strong> ${pbkdf2Match ? '✅ YES' : '❌ NO'}</p>
                    <p><strong>Plain Text Match:</strong> ${plainTextMatch ? '✅ YES' : '❌ NO'}</p>
                    <hr>
                    <p><strong>SHA256 Generated:</strong> ${sha256Hash.substring(0, 30)}...</p>
                    <p><strong>Recommendation:</strong> ${pbkdf2Match ? 'User has secure PBKDF2 password' : sha256Match ? 'User has legacy SHA256 password' : plainTextMatch ? 'User has plain text password (needs upgrade)' : 'Password does not match any format'}</p>
                `
            } catch (error) {
                console.error('Error testing password:', error)
                resultsDiv.innerHTML = `
                    <p style="color: red;">❌ Error testing password</p>
                    <p>Error: ${error.message}</p>
                `
            }
        }

        // Load crypto-js after a delay
        setTimeout(() => {
            console.log('Password debug tool ready')
        }, 1000)
    </script>
</body>
</html>
