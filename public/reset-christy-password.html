<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Christy Password</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <h1>Reset Christy's Password</h1>
    
    <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <h3>‚ö†Ô∏è Status Saat Ini:</h3>
        <p><strong>Irene:</strong> ‚úÖ Password bekerja normal (PBKDF2 format)</p>
        <p><strong>Christy:</strong> ‚ùå Password tidak cocok dengan hash di database</p>
        <p><strong>Sistem:</strong> ‚úÖ Berfungsi dengan benar</p>
    </div>
    
    <div>
        <h3>Reset Password untuk Christy</h3>
        <p>Masukkan password baru untuk Christy Potabuga:</p>
        <input type="password" id="newPassword" placeholder="Password baru untuk Christy" style="width: 300px; padding: 10px;" />
        <input type="password" id="confirmPassword" placeholder="Konfirmasi password" style="width: 300px; padding: 10px;" />
        <br><br>
        <button onclick="resetChristyPassword()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">Reset Password Christy</button>
    </div>
    
    <div>
        <h3>Verifikasi Setelah Reset</h3>
        <input type="password" id="testNewPassword" placeholder="Test password baru" style="width: 300px; padding: 10px;" />
        <button onclick="testChristyNewPassword()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px;">Test Password Baru</button>
    </div>
    
    <div id="results" style="margin-top: 20px; padding: 10px; background: #f0f0f0; white-space: pre-wrap; font-family: monospace;">
        Tool siap digunakan. Masukkan password baru untuk Christy.
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js'
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js'

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA3Rm_kfJo5QsmJCMfNJYdoV9CYfN9o4gE",
            authDomain: "myrajawali-app.firebaseapp.com",
            projectId: "myrajawali-app",
            storageBucket: "myrajawali-app.appspot.com",
            messagingSenderId: "1090503445464",
            appId: "1:1090503445464:web:7e50c38b29b1af47ce66eb"
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig)
        const db = getFirestore(app)

        function log(message) {
            const resultsDiv = document.getElementById('results')
            resultsDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n'
            console.log(message)
        }

        function hashPasswordPBKDF2(password) {
            const salt = CryptoJS.lib.WordArray.random(128/8)
            const hash = CryptoJS.PBKDF2(password, salt, {
                keySize: 256/32,
                iterations: 10000
            })
            return salt.toString() + ':' + hash.toString()
        }

        function verifyPasswordPBKDF2(password, storedHash) {
            try {
                if (!storedHash.includes(':')) {
                    return password === storedHash
                }
                
                const [salt, hash] = storedHash.split(':')
                const hashToVerify = CryptoJS.PBKDF2(password, CryptoJS.enc.Hex.parse(salt), {
                    keySize: 256/32,
                    iterations: 10000
                })
                return hash === hashToVerify.toString()
            } catch (error) {
                return false
            }
        }

        async function findChristy() {
            const jemaatRef = collection(db, 'jemaat')
            
            // Try exact match first
            const exactQuery = query(jemaatRef, where('nama', '==', 'Christy Potabuga'))
            const exactSnapshot = await getDocs(exactQuery)
            
            if (!exactSnapshot.empty) {
                return { doc: exactSnapshot.docs[0], data: exactSnapshot.docs[0].data() }
            }
            
            // Try case-insensitive search
            const allSnapshot = await getDocs(jemaatRef)
            for (const doc of allSnapshot.docs) {
                const data = doc.data()
                if (data.nama && data.nama.toLowerCase().includes('christy')) {
                    return { doc, data }
                }
            }
            
            return null
        }

        window.resetChristyPassword = async () => {
            const newPassword = document.getElementById('newPassword').value
            const confirmPassword = document.getElementById('confirmPassword').value
            
            if (!newPassword) {
                log('‚ùå Password baru harus diisi')
                return
            }
            
            if (newPassword.length < 6) {
                log('‚ùå Password minimal 6 karakter')
                return
            }
            
            if (newPassword !== confirmPassword) {
                log('‚ùå Konfirmasi password tidak cocok')
                return
            }
            
            try {
                log('üîÑ Mencari akun Christy...')
                
                const result = await findChristy()
                if (!result) {
                    log('‚ùå Akun Christy tidak ditemukan')
                    return
                }
                
                const { doc: christyDoc, data: christyData } = result
                log(`‚úÖ Ditemukan akun: ${christyData.nama}`)
                
                // Hash password baru
                log('üîê Membuat hash password baru...')
                const hashedPassword = hashPasswordPBKDF2(newPassword)
                
                // Update password di database
                log('üíæ Mengupdate password di database...')
                await updateDoc(christyDoc.ref, {
                    password: hashedPassword,
                    passwordResetAt: serverTimestamp(),
                    passwordResetBy: 'admin_tool',
                    lastPasswordChange: serverTimestamp(),
                    failedLoginAttempts: 0,
                    lastLoginAttempt: null,
                    lockedUntil: null
                })
                
                log('‚úÖ Password berhasil direset!')
                log(`üìã Detail:`)
                log(`   - User: ${christyData.nama}`)
                log(`   - Password baru: ${newPassword}`)
                log(`   - Hash baru: ${hashedPassword.substring(0, 30)}...`)
                log(`   - Failed attempts direset ke 0`)
                log('')
                log('üéâ Christy sekarang bisa login dengan password baru!')
                
            } catch (error) {
                log(`‚ùå Error reset password: ${error.message}`)
            }
        }

        window.testChristyNewPassword = async () => {
            const testPassword = document.getElementById('testNewPassword').value
            
            if (!testPassword) {
                log('‚ùå Masukkan password untuk ditest')
                return
            }
            
            try {
                log('üß™ Testing password baru untuk Christy...')
                
                const result = await findChristy()
                if (!result) {
                    log('‚ùå Akun Christy tidak ditemukan')
                    return
                }
                
                const { data: christyData } = result
                const storedPassword = christyData.password
                
                if (!storedPassword) {
                    log('‚ùå Tidak ada password tersimpan')
                    return
                }
                
                const isValid = verifyPasswordPBKDF2(testPassword, storedPassword)
                
                log(`üìä Hasil test password:`)
                log(`   - Input: ${testPassword}`)
                log(`   - Stored: ${storedPassword.substring(0, 30)}...`)
                log(`   - Valid: ${isValid ? '‚úÖ YA' : '‚ùå TIDAK'}`)
                
                if (isValid) {
                    log('')
                    log('üéâ PASSWORD BENAR! Christy sekarang bisa login!')
                } else {
                    log('')
                    log('‚ùå Password masih salah. Coba reset ulang.')
                }
                
            } catch (error) {
                log(`‚ùå Error testing password: ${error.message}`)
            }
        }

        log('Tool siap digunakan!')
    </script>
</body>
</html>
