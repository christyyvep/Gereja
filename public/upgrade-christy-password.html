<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade Christy Password</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <h1>üîê Upgrade Christy Password to Secure Format</h1>
    
    <div style="background: #e8f5e8; padding: 15px; margin: 20px 0; border-radius: 5px; border-left: 5px solid #4caf50;">
        <h3>‚úÖ STATUS: Christy Login BERHASIL!</h3>
        <p>Sekarang mari upgrade password Christy ke format yang lebih secure (PBKDF2)</p>
        <p>Password simple saat ini akan di-upgrade tanpa mengubah login experience</p>
    </div>
    
    <div>
        <h3>Upgrade Password Christy</h3>
        <p>Masukkan password simple yang sekarang digunakan Christy:</p>
        <input type="password" id="currentPassword" placeholder="Password simple saat ini" style="width: 300px; padding: 10px;" />
        <br><br>
        <button onclick="upgradeChristyPassword()" style="padding: 15px 30px; background: #2196f3; color: white; border: none; border-radius: 5px; font-size: 16px;">üîí UPGRADE TO SECURE HASH</button>
    </div>
    
    <div>
        <h3>Test Password Setelah Upgrade</h3>
        <input type="password" id="testPassword" placeholder="Test password setelah upgrade" style="width: 300px; padding: 10px;" />
        <button onclick="testUpgradedPassword()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 5px;">‚úÖ TEST</button>
    </div>
    
    <div id="results" style="margin-top: 20px; padding: 15px; background: #f5f5f5; white-space: pre-wrap; font-family: monospace; border-radius: 5px; max-height: 400px; overflow-y: auto;">
Tool ready. Masukkan password simple Christy yang sekarang untuk upgrade ke format secure.
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js'
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js'

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA3Rm_kfJo5QsmJCMfNJYdoV9CYfN9o4gE",
            authDomain: "myrajawali-app.firebaseapp.com",
            projectId: "myrajawali-app",
            storageBucket: "myrajawali-app.appspot.com",
            messagingSenderId: "1090503445464",
            appId: "1:1090503445464:web:7e50c38b29b1af47ce66eb"
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig)
        const db = getFirestore(app)

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results')
            const timestamp = new Date().toLocaleTimeString()
            
            const colors = {
                info: '#333',
                success: '#2e7d32',
                warning: '#f57c00',
                error: '#d32f2f'
            }
            
            resultsDiv.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`
            resultsDiv.scrollTop = resultsDiv.scrollHeight
        }

        function hashPasswordPBKDF2(password) {
            const salt = CryptoJS.lib.WordArray.random(128/8)
            const hash = CryptoJS.PBKDF2(password, salt, {
                keySize: 256/32,
                iterations: 10000
            })
            return salt.toString() + ':' + hash.toString()
        }

        function verifyPasswordPBKDF2(password, storedHash) {
            try {
                if (!storedHash.includes(':')) {
                    return password === storedHash
                }
                
                const [salt, hash] = storedHash.split(':')
                const hashToVerify = CryptoJS.PBKDF2(password, CryptoJS.enc.Hex.parse(salt), {
                    keySize: 256/32,
                    iterations: 10000
                })
                return hash === hashToVerify.toString()
            } catch (error) {
                return false
            }
        }

        async function findChristy() {
            const jemaatRef = collection(db, 'jemaat')
            const allSnapshot = await getDocs(jemaatRef)
            
            for (const doc of allSnapshot.docs) {
                const data = doc.data()
                if (data.nama && data.nama.toLowerCase().includes('christy')) {
                    return { doc, data }
                }
            }
            return null
        }

        window.upgradeChristyPassword = async () => {
            const currentPassword = document.getElementById('currentPassword').value
            
            if (!currentPassword) {
                log('‚ùå Masukkan password simple yang sekarang digunakan', 'error')
                return
            }
            
            try {
                log('üîç Mencari akun Christy...', 'info')
                
                const result = await findChristy()
                if (!result) {
                    log('‚ùå Akun Christy tidak ditemukan', 'error')
                    return
                }
                
                const { doc: christyDoc, data: christyData } = result
                log(`‚úÖ Ditemukan akun: ${christyData.nama}`, 'success')
                
                // Verify current password works
                log('üîê Memverifikasi password saat ini...', 'info')
                const currentValid = verifyPasswordPBKDF2(currentPassword, christyData.password) || 
                                   (currentPassword === christyData.password)
                
                if (!currentValid) {
                    log('‚ùå Password saat ini tidak cocok! Pastikan password yang dimasukkan benar', 'error')
                    return
                }
                
                log('‚úÖ Password saat ini valid', 'success')
                log(`Format saat ini: ${christyData.password.includes(':') ? 'PBKDF2' : 'Simple/Plain'}`, 'info')
                
                // Generate secure PBKDF2 hash
                log('üîí Membuat hash PBKDF2 yang secure...', 'info')
                const secureHash = hashPasswordPBKDF2(currentPassword)
                
                // Update password in database
                log('üíæ Mengupdate password di database...', 'info')
                await updateDoc(christyDoc.ref, {
                    password: secureHash,
                    passwordUpgradedAt: serverTimestamp(),
                    passwordUpgradedFrom: christyData.password.includes(':') ? 'pbkdf2' : 'simple',
                    passwordMethod: 'pbkdf2_secure',
                    securityVersion: '2.1',
                    lastPasswordChange: serverTimestamp()
                })
                
                log('‚úÖ PASSWORD BERHASIL DI-UPGRADE!', 'success')
                log('', 'info')
                log('üìã Detail Upgrade:', 'info')
                log(`   - User: ${christyData.nama}`, 'info')
                log(`   - Password: ${currentPassword} (SAMA, tidak berubah)`, 'info')
                log(`   - Format lama: ${christyData.password.substring(0, 30)}...`, 'info')
                log(`   - Format baru: ${secureHash.substring(0, 30)}... (PBKDF2 Secure)`, 'info')
                log('', 'info')
                log('üéâ Christy sekarang menggunakan password format yang sangat secure!', 'success')
                log('üîê Password tetap sama, tapi sekarang di-hash dengan PBKDF2 + salt', 'success')
                
            } catch (error) {
                log(`‚ùå Error upgrade password: ${error.message}`, 'error')
            }
        }

        window.testUpgradedPassword = async () => {
            const testPassword = document.getElementById('testPassword').value
            
            if (!testPassword) {
                log('‚ùå Masukkan password untuk ditest', 'error')
                return
            }
            
            try {
                log('üß™ Testing password setelah upgrade...', 'info')
                
                const result = await findChristy()
                if (!result) {
                    log('‚ùå Akun Christy tidak ditemukan', 'error')
                    return
                }
                
                const { data: christyData } = result
                const storedPassword = christyData.password
                
                const isValid = verifyPasswordPBKDF2(testPassword, storedPassword)
                
                log(`üìä Hasil test:`, 'info')
                log(`   - Input: ${testPassword}`, 'info')
                log(`   - Format: ${storedPassword.includes(':') ? 'PBKDF2 Secure' : 'Simple/Plain'}`, 'info')
                log(`   - Valid: ${isValid ? '‚úÖ YA' : '‚ùå TIDAK'}`, isValid ? 'success' : 'error')
                
                if (isValid) {
                    log('', 'info')
                    log('üéâ PASSWORD BEKERJA DENGAN SEMPURNA!', 'success')
                    log('Christy bisa login dengan password yang sama tapi sekarang dengan security tinggi', 'success')
                } else {
                    log('', 'info')
                    log('‚ùå Password tidak cocok. Ada masalah dengan upgrade.', 'error')
                }
                
            } catch (error) {
                log(`‚ùå Error testing password: ${error.message}`, 'error')
            }
        }

        log('üîê Password Upgrade Tool Ready!', 'success')
        log('Masukkan password simple Christy yang sekarang untuk upgrade ke PBKDF2 secure format', 'info')
    </script>
</body>
</html>
