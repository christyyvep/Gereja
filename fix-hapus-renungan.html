<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Hapus Renungan - MyRajawali Admin</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; }
        .loading { background: #e2e3e5; border: 1px solid #d6d8db; color: #6c757d; }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 8px 0;
            box-sizing: border-box;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîß Fix Hapus Renungan - Admin Panel</h1>
    <p>Tool untuk memperbaiki masalah hapus renungan di halaman admin.</p>

    <div class="card">
        <h3>üîç 1. Debug Authentication Status</h3>
        <p>Cek status login admin dan permisi:</p>
        <button onclick="checkAuthStatus()" class="btn">Check Auth Status</button>
        <div id="authResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h3>üîê 2. Login sebagai Admin</h3>
        <div>
            <label>Nama:</label>
            <input type="text" id="adminName" value="Christy Potabuga" placeholder="Masukkan nama admin">
        </div>
        <div>
            <label>Password:</label>
            <input type="password" id="adminPassword" value="admin123" placeholder="Masukkan password">
        </div>
        <button onclick="loginAdmin()" class="btn">Login Admin</button>
        <div id="loginResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h3>üìù 3. Test Create Renungan</h3>
        <p>Buat renungan test untuk dicoba dihapus:</p>
        <button onclick="createTestRenungan()" class="btn btn-success">Buat Test Renungan</button>
        <div id="createResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h3>üìã 4. List Renungan</h3>
        <p>Lihat daftar renungan yang tersedia:</p>
        <button onclick="listRenungan()" class="btn">List All Renungan</button>
        <div id="listResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h3>üóëÔ∏è 5. Test Hapus Renungan</h3>
        <p>Test fungsi hapus renungan (gunakan ID dari list di atas):</p>
        <div>
            <label>Renungan ID:</label>
            <input type="text" id="renunganId" placeholder="Masukkan ID renungan yang akan dihapus">
        </div>
        <button onclick="deleteRenungan()" class="btn btn-danger">Hapus Renungan</button>
        <div id="deleteResult" class="result" style="display: none;"></div>
    </div>

    <div class="card">
        <h3>üîß 6. Fix Firebase Permissions</h3>
        <p>Test dan perbaiki permission untuk admin:</p>
        <button onclick="checkFirebasePermissions()" class="btn">Check Permissions</button>
        <button onclick="fixAdminPermissions()" class="btn btn-warning">Fix Admin Role</button>
        <div id="permissionResult" class="result" style="display: none;"></div>
    </div>

    <!-- Import Firebase dan services -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDocs, 
            getDoc,
            addDoc, 
            deleteDoc, 
            updateDoc,
            query, 
            orderBy, 
            limit,
            where
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'
        import { 
            getAuth, 
            signInAnonymously,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA3K7DyOJ_E1fYvbQJ0GSTIDCf6WJMGVD4",
            authDomain: "myrajawali-app.firebaseapp.com",
            projectId: "myrajawali-app",
            storageBucket: "myrajawali-app.appspot.com",
            messagingSenderId: "87193863892",
            appId: "1:87193863892:web:3e543de298c4bb5e24c25e"
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig)
        const db = getFirestore(app)
        const auth = getAuth(app)

        let currentTestRenunganId = null
        let currentUser = null

        // Check auth status
        window.checkAuthStatus = async function() {
            const resultDiv = document.getElementById('authResult')
            resultDiv.className = 'result loading'
            resultDiv.style.display = 'block'
            resultDiv.textContent = '‚è≥ Checking authentication status...'
            
            try {
                // Check localStorage
                const localUser = localStorage.getItem('myrajawali_user')
                const session = localStorage.getItem('myrajawali_session')
                
                // Check Firebase Auth
                const firebaseUser = auth.currentUser
                
                let authInfo = `üìä AUTHENTICATION STATUS\n\n`
                authInfo += `üè† Local Storage User: ${localUser ? '‚úÖ Present' : '‚ùå Missing'}\n`
                authInfo += `üîë Session: ${session ? '‚úÖ Present' : '‚ùå Missing'}\n`
                authInfo += `üî• Firebase Auth: ${firebaseUser ? '‚úÖ Signed In' : '‚ùå Not Signed In'}\n\n`
                
                if (localUser) {
                    const userData = JSON.parse(localUser)
                    authInfo += `üë§ User Details:\n`
                    authInfo += `   Nama: ${userData.nama}\n`
                    authInfo += `   Role: ${userData.role}\n`
                    authInfo += `   ID: ${userData.id}\n\n`
                }
                
                if (session) {
                    const sessionData = JSON.parse(session)
                    authInfo += `üé´ Session Details:\n`
                    authInfo += `   Session ID: ${sessionData.sessionId}\n`
                    authInfo += `   Expires: ${new Date(sessionData.expiresAt).toLocaleString()}\n`
                    authInfo += `   Valid: ${sessionData.expiresAt > Date.now() ? '‚úÖ Yes' : '‚ùå Expired'}\n\n`
                }
                
                // Check database permission
                try {
                    const testQuery = query(collection(db, 'devotionals'), limit(1))
                    const snapshot = await getDocs(testQuery)
                    authInfo += `üóÑÔ∏è Database Access: ‚úÖ Can read devotionals (${snapshot.size} docs)\n`
                } catch (error) {
                    authInfo += `üóÑÔ∏è Database Access: ‚ùå ${error.message}\n`
                }
                
                resultDiv.className = 'result info'
                resultDiv.textContent = authInfo
                
            } catch (error) {
                resultDiv.className = 'result error'
                resultDiv.textContent = `‚ùå Error checking auth: ${error.message}`
            }
        }

        // Login admin
        window.loginAdmin = async function() {
            const name = document.getElementById('adminName').value
            const password = document.getElementById('adminPassword').value
            const resultDiv = document.getElementById('loginResult')
            
            if (!name || !password) {
                resultDiv.className = 'result error'
                resultDiv.style.display = 'block'
                resultDiv.textContent = '‚ùå Nama dan password harus diisi!'
                return
            }
            
            resultDiv.className = 'result loading'
            resultDiv.style.display = 'block'
            resultDiv.textContent = '‚è≥ Logging in...'
            
            try {
                // 1. Sign in to Firebase Auth anonymously first
                await signInAnonymously(auth)
                
                // 2. Find user in jemaat collection
                const jemaatRef = collection(db, 'jemaat')
                const q = query(jemaatRef, where('nama', '==', name))
                const snapshot = await getDocs(q)
                
                if (snapshot.empty) {
                    throw new Error(`User '${name}' tidak ditemukan di database`)
                }
                
                const userDoc = snapshot.docs[0]
                const userData = userDoc.data()
                
                // Simple password check (for testing)
                if (userData.password !== password) {
                    throw new Error('Password salah')
                }
                
                // Check if user is admin
                if (userData.role !== 'admin' && userData.role !== 'gembala') {
                    throw new Error(`User '${name}' bukan admin. Role: ${userData.role || 'jemaat'}`)
                }
                
                // 3. Create session
                const sessionData = {
                    sessionId: 'manual-session-' + Date.now(),
                    userId: userDoc.id,
                    nama: userData.nama,
                    role: userData.role,
                    jemaatId: userDoc.id,
                    loginAt: Date.now(),
                    expiresAt: Date.now() + (60 * 60 * 1000), // 1 hour
                }
                
                // 4. Save to localStorage
                localStorage.setItem('myrajawali_session', JSON.stringify(sessionData))
                localStorage.setItem('myrajawali_user', JSON.stringify({
                    id: userDoc.id,
                    nama: userData.nama,
                    role: userData.role,
                    email: userData.email || '',
                }))
                
                // 5. Create auth session in Firestore for security rules
                const authSessionRef = doc(db, 'auth_sessions', auth.currentUser.uid)
                await updateDoc(authSessionRef, {
                    ...sessionData,
                    lastActivity: new Date()
                }).catch(async () => {
                    // If doc doesn't exist, create it
                    await addDoc(collection(db, 'auth_sessions'), {
                        uid: auth.currentUser.uid,
                        ...sessionData,
                        lastActivity: new Date()
                    })
                })
                
                currentUser = userData
                
                resultDiv.className = 'result success'
                resultDiv.textContent = `‚úÖ Login berhasil!\n\nUser: ${userData.nama}\nRole: ${userData.role}\nFirebase UID: ${auth.currentUser.uid}\nSession ID: ${sessionData.sessionId}\n\nüéâ Admin authentication ready!`
                
            } catch (error) {
                console.error('Login error:', error)
                resultDiv.className = 'result error'
                resultDiv.textContent = `‚ùå Login gagal: ${error.message}`
            }
        }

        // Create test renungan
        window.createTestRenungan = async function() {
            const resultDiv = document.getElementById('createResult')
            resultDiv.className = 'result loading'
            resultDiv.style.display = 'block'
            resultDiv.textContent = '‚è≥ Creating test renungan...'
            
            try {
                if (!currentUser) {
                    throw new Error('Silakan login sebagai admin terlebih dahulu')
                }
                
                const testData = {
                    title: `Test Renungan - ${new Date().toLocaleString()}`,
                    content: 'Ini adalah renungan test yang akan dicoba untuk dihapus. Berisi konten test untuk keperluan debugging.',
                    verse: 'Yohanes 3:16 - "Karena begitu besar kasih Allah akan dunia ini..."',
                    date: new Date().toISOString().split('T')[0],
                    category: 'harian',
                    createdBy: currentUser.nama || 'test-admin',
                    createdAt: new Date(),
                    isPublished: true
                }
                
                const devotionalRef = await addDoc(collection(db, 'devotionals'), testData)
                currentTestRenunganId = devotionalRef.id
                
                resultDiv.className = 'result success'
                resultDiv.textContent = `‚úÖ Test renungan berhasil dibuat!\n\nID: ${devotionalRef.id}\nTitle: ${testData.title}\nCreated by: ${testData.createdBy}\n\nüìã ID sudah otomatis diisi di form hapus renungan.`
                
                // Auto-fill the delete form
                document.getElementById('renunganId').value = devotionalRef.id
                
            } catch (error) {
                console.error('Create error:', error)
                resultDiv.className = 'result error'
                resultDiv.textContent = `‚ùå Gagal membuat test renungan: ${error.message}`
            }
        }

        // List renungan
        window.listRenungan = async function() {
            const resultDiv = document.getElementById('listResult')
            resultDiv.className = 'result loading'
            resultDiv.style.display = 'block'
            resultDiv.textContent = '‚è≥ Loading renungan...'
            
            try {
                const devotionalRef = collection(db, 'devotionals')
                const q = query(devotionalRef, orderBy('createdAt', 'desc'), limit(10))
                const snapshot = await getDocs(q)
                
                let listText = `üìö DAFTAR RENUNGAN (${snapshot.size} items):\n\n`
                
                snapshot.forEach((doc, index) => {
                    const data = doc.data()
                    listText += `${index + 1}. ${data.title}\n`
                    listText += `   ID: ${doc.id}\n`
                    listText += `   Date: ${data.date || 'No date'}\n`
                    listText += `   Created: ${data.createdAt?.toDate?.()?.toLocaleString() || 'No timestamp'}\n`
                    listText += `   By: ${data.createdBy || 'Unknown'}\n`
                    
                    if (doc.id === currentTestRenunganId) {
                        listText += `   üëÜ TEST RENUNGAN INI\n`
                    }
                    listText += '\n'
                })
                
                if (snapshot.empty) {
                    listText += 'üì≠ Tidak ada renungan ditemukan.\n\nüí° Buat test renungan terlebih dahulu.'
                }
                
                resultDiv.className = 'result success'
                resultDiv.textContent = listText
                
            } catch (error) {
                console.error('List error:', error)
                resultDiv.className = 'result error'
                resultDiv.textContent = `‚ùå Gagal load renungan: ${error.message}`
            }
        }

        // Delete renungan
        window.deleteRenungan = async function() {
            const renunganId = document.getElementById('renunganId').value
            const resultDiv = document.getElementById('deleteResult')
            
            if (!renunganId) {
                resultDiv.className = 'result error'
                resultDiv.style.display = 'block'
                resultDiv.textContent = '‚ùå ID renungan harus diisi!'
                return
            }
            
            if (!currentUser) {
                resultDiv.className = 'result error'
                resultDiv.style.display = 'block'
                resultDiv.textContent = '‚ùå Silakan login sebagai admin terlebih dahulu!'
                return
            }
            
            const confirmed = confirm(`Yakin hapus renungan dengan ID: ${renunganId}?`)
            if (!confirmed) return
            
            resultDiv.className = 'result loading'
            resultDiv.style.display = 'block'
            resultDiv.textContent = `‚è≥ Deleting renungan ID: ${renunganId}...`
            
            try {
                // 1. Get renungan data first
                const docRef = doc(db, 'devotionals', renunganId)
                const docSnap = await getDoc(docRef)
                
                if (!docSnap.exists()) {
                    throw new Error(`Renungan dengan ID '${renunganId}' tidak ditemukan`)
                }
                
                const renunganData = docSnap.data()
                
                // 2. Delete the document
                await deleteDoc(docRef)
                
                // 3. Log success
                resultDiv.className = 'result success'
                resultDiv.textContent = `‚úÖ Renungan berhasil dihapus!\n\nDeleted ID: ${renunganId}\nTitle: ${renunganData.title}\nDeleted by: ${currentUser.nama}\nTimestamp: ${new Date().toLocaleString()}\n\nüéâ FITUR HAPUS RENUNGAN SUDAH BEKERJA!`
                
                // Clear the form
                document.getElementById('renunganId').value = ''
                currentTestRenunganId = null
                
            } catch (error) {
                console.error('Delete error:', error)
                resultDiv.className = 'result error'
                
                let errorMsg = `‚ùå Gagal hapus renungan: ${error.message}\n\n`
                errorMsg += `Debug info:\n`
                errorMsg += `- Renungan ID: ${renunganId}\n`
                errorMsg += `- Current User: ${currentUser?.nama || 'None'}\n`
                errorMsg += `- User Role: ${currentUser?.role || 'None'}\n`
                errorMsg += `- Firebase UID: ${auth.currentUser?.uid || 'None'}\n`
                errorMsg += `- Error Code: ${error.code || 'N/A'}\n`
                
                resultDiv.textContent = errorMsg
            }
        }

        // Check Firebase permissions
        window.checkFirebasePermissions = async function() {
            const resultDiv = document.getElementById('permissionResult')
            resultDiv.className = 'result loading'
            resultDiv.style.display = 'block'
            resultDiv.textContent = '‚è≥ Checking Firebase permissions...'
            
            try {
                let permissionInfo = `üîê FIREBASE PERMISSIONS CHECK\n\n`
                
                // Test read permissions
                try {
                    const testQuery = query(collection(db, 'devotionals'), limit(1))
                    const snapshot = await getDocs(testQuery)
                    permissionInfo += `üìñ Read devotionals: ‚úÖ OK (${snapshot.size} docs)\n`
                } catch (error) {
                    permissionInfo += `üìñ Read devotionals: ‚ùå ${error.message}\n`
                }
                
                // Test write permissions (create)
                try {
                    const testDoc = {
                        title: 'Permission Test',
                        content: 'Test doc for permissions',
                        createdAt: new Date(),
                        isTest: true
                    }
                    const docRef = await addDoc(collection(db, 'devotionals'), testDoc)
                    permissionInfo += `‚úèÔ∏è Create devotional: ‚úÖ OK (created ${docRef.id})\n`
                    
                    // Clean up test doc
                    await deleteDoc(doc(db, 'devotionals', docRef.id))
                    permissionInfo += `üóëÔ∏è Delete devotional: ‚úÖ OK (deleted ${docRef.id})\n`
                    
                } catch (error) {
                    permissionInfo += `‚úèÔ∏è Create devotional: ‚ùå ${error.message}\n`
                }
                
                // Check auth session
                if (auth.currentUser) {
                    try {
                        const authSessionRef = doc(db, 'auth_sessions', auth.currentUser.uid)
                        const authDoc = await getDoc(authSessionRef)
                        if (authDoc.exists()) {
                            permissionInfo += `üé´ Auth session: ‚úÖ OK (${authDoc.data().role})\n`
                        } else {
                            permissionInfo += `üé´ Auth session: ‚ö†Ô∏è Not found\n`
                        }
                    } catch (error) {
                        permissionInfo += `üé´ Auth session: ‚ùå ${error.message}\n`
                    }
                }
                
                resultDiv.className = 'result info'
                resultDiv.textContent = permissionInfo
                
            } catch (error) {
                resultDiv.className = 'result error'
                resultDiv.textContent = `‚ùå Permission check failed: ${error.message}`
            }
        }

        // Fix admin permissions
        window.fixAdminPermissions = async function() {
            const resultDiv = document.getElementById('permissionResult')
            resultDiv.className = 'result loading'
            resultDiv.style.display = 'block'
            resultDiv.textContent = '‚è≥ Fixing admin permissions...'
            
            try {
                if (!currentUser) {
                    throw new Error('Login as admin first!')
                }
                
                if (!auth.currentUser) {
                    throw new Error('Firebase auth required!')
                }
                
                // Update/create auth session
                const sessionData = {
                    sessionId: 'fixed-session-' + Date.now(),
                    userId: currentUser.id,
                    nama: currentUser.nama,
                    role: currentUser.role,
                    jemaatId: currentUser.id,
                    loginAt: Date.now(),
                    expiresAt: Date.now() + (60 * 60 * 1000), // 1 hour
                    lastActivity: new Date(),
                    uid: auth.currentUser.uid
                }
                
                const authSessionRef = doc(db, 'auth_sessions', auth.currentUser.uid)
                await updateDoc(authSessionRef, sessionData).catch(async () => {
                    // Create if doesn't exist
                    await addDoc(collection(db, 'auth_sessions'), sessionData)
                })
                
                // Update localStorage
                localStorage.setItem('myrajawali_session', JSON.stringify(sessionData))
                
                resultDiv.className = 'result success'
                resultDiv.textContent = `‚úÖ Admin permissions fixed!\n\nUpdated auth session for:\n- User: ${currentUser.nama}\n- Role: ${currentUser.role}\n- Firebase UID: ${auth.currentUser.uid}\n\nüîÑ Try the delete function again.`
                
            } catch (error) {
                resultDiv.className = 'result error'
                resultDiv.textContent = `‚ùå Failed to fix permissions: ${error.message}`
            }
        }

        // Auto-check auth on load
        window.addEventListener('load', () => {
            checkAuthStatus()
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log('Firebase Auth state: Signed in', user.uid)
                } else {
                    console.log('Firebase Auth state: Signed out')
                }
            })
        })
    </script>
</body>
</html>
